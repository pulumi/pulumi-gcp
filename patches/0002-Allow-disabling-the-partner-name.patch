From bb333b7981152eafcd5d55c0ed4ead2eea8a76d5 Mon Sep 17 00:00:00 2001
From: Daniel Bradley <daniel@pulumi.com>
Date: Tue, 7 Mar 2023 11:09:59 +0000
Subject: [PATCH 02/10] Allow disabling the partner name

Add options to set or disable partner name.
---
 google-beta/provider.go          |  2 +-
 google-beta/provider/provider.go | 28 ++++++++++++++++++++++++++++
 google-beta/utils.go             |  6 +++---
 3 files changed, 32 insertions(+), 4 deletions(-)

diff --git a/google-beta/provider.go b/google-beta/provider.go
index 7d5c9f0fa..cfe3dd382 100644
--- a/google-beta/provider.go
+++ b/google-beta/provider.go
@@ -10,7 +10,7 @@ import (
 // Provider returns a *schema.Provider.
 
 // This function stays in the google package temporarily to not break the terraform-google-conversion.
-// TODO: remove it in a later PR
+// TODO: remove it in a later PR
 func Provider() *schema.Provider {
 	return provider.Provider()
 }
diff --git a/google-beta/provider/provider.go b/google-beta/provider/provider.go
index 18525137c..7c57bd89f 100644
--- a/google-beta/provider/provider.go
+++ b/google-beta/provider/provider.go
@@ -226,6 +226,19 @@ func Provider() *schema.Provider {
 				Optional: true,
 			},
 
+			"google_partner_name": {
+				Type:     schema.TypeString,
+				Optional: true,
+			},
+
+			"disable_google_partner_name": {
+				Type:     schema.TypeBool,
+				Optional: true,
+				DefaultFunc: schema.MultiEnvDefaultFunc([]string{
+					"GOOGLE_DISABLE_PARTNER_NAME",
+				}, nil),
+			},
+
 			"request_reason": {
 				Type:     schema.TypeString,
 				Optional: true,
@@ -1823,6 +1836,21 @@ func providerConfigure(ctx context.Context, d *schema.ResourceData, p *schema.Pr
 		UserAgent:           p.UserAgent("terraform-provider-google-beta", version.ProviderVersion),
 	}
 
+	disablePartnerName := d.Get("disable_google_partner_name").(bool)
+	userSpecifiedPartnerName := d.Get("google_partner_name")
+
+	partnerString := ""
+	if !disablePartnerName {
+		if userSpecifiedPartnerName != "" {
+			partnerString = fmt.Sprintf("GPN:%s; ", userSpecifiedPartnerName)
+		} else {
+			partnerString = "GPN:Pulumi; "
+		}
+	}
+	userAgent := fmt.Sprintf("Pulumi/3.0 (%shttps://www.pulumi.com) pulumi-gcp/%s", partnerString, version.ProviderVersion)
+
+	config.UserAgent = userAgent
+
 	// opt in extension for adding to the User-Agent header
 	if ext := os.Getenv("GOOGLE_TERRAFORM_USERAGENT_EXTENSION"); ext != "" {
 		ua := config.UserAgent
diff --git a/google-beta/utils.go b/google-beta/utils.go
index d0f4777ca..dc0f460e4 100644
--- a/google-beta/utils.go
+++ b/google-beta/utils.go
@@ -284,10 +284,10 @@ func changeFieldSchemaToForceNew(sch *schema.Schema) {
 	tpgresource.ChangeFieldSchemaToForceNew(sch)
 }
 
-// Deprecated: For backward compatibility generateUserAgentString is still working,
-// but all new code should use GenerateUserAgentString in the tpgresource package instead.
 func generateUserAgentString(d tpgresource.TerraformResourceData, currentUserAgent string) (string, error) {
-	return tpgresource.GenerateUserAgentString(d, currentUserAgent)
+	// we don't want to append the name of the module here as it doesn't make any sense to
+	// do this with the pulumi provider
+	return currentUserAgent, nil
 }
 
 // Deprecated: For backward compatibility snakeToPascalCase is still working,
-- 
2.41.0

